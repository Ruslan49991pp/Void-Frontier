# Система оружия VoidFrontier

## Обзор

Реализована полная система оружия для игры VoidFrontier, включающая оружие ближнего и дальнего боя с автоматическим выбором в зависимости от дистанции до цели.

## Ключевые компоненты

### 1. Базовые классы

#### `Weapon.cs` - Абстрактный базовый класс
- Базовые характеристики: урон, дальность, скорость атаки, точность
- Система прочности и ремонта
- Рассчет финального урона с учетом состояния оружия

#### `MeleeWeapon.cs` - Оружие ближнего боя
- **Категории**: Нож, Меч, Дубинка, Топор
- **Особенности**:
  - Критические удары с настраиваемым шансом и множителем
  - Анимация атаки с выпадом вперед
  - Визуальные эффекты урона
- **Дальность**: 1.5 единицы (соседние клетки)

#### `RangedWeapon.cs` - Огнестрельное оружие
- **Категории**: Пистолет, Винтовка, Дробовик, ПП
- **Особенности**:
  - Система магазинов и перезарядки
  - Отдача, влияющая на точность
  - Автоматический и одиночный режимы стрельбы
  - Визуальные эффекты выстрела
- **Дальность**: 5-15 единиц в зависимости от типа

### 2. Система снарядов

#### `Bullet.cs` - Компонент пули
- **Физика полета**: Реалистичная траектория как в RimWorld
- **Баллистика**: Разброс в зависимости от точности оружия
- **Попадания**: Обработка попаданий в персонажей и препятствия
- **Визуальные эффекты**: След пули и эффекты попадания
- **Пробитие**: Опциональная возможность пробивания целей

### 3. Система управления оружием

#### `WeaponSystem.cs` - Менеджер оружия персонажа
- **Автовыбор оружия**: Умный выбор в зависимости от дистанции
- **Зоны предпочтения**:
  - Ближний бой: < 3 единиц
  - Дальний бой: > 3 единиц
- **Автоперезарядка**: Автоматическая перезарядка при необходимости
- **Статистика**: Отслеживание использования оружия

### 4. Система отображения урона

#### `LookAtCamera.cs` - Billboard компонент
- **Автоповорот к камере**: Текст урона всегда развернут к игроку
- **Оптимизация**: Обновление только при изменении позиции камеры
- **Гибкие настройки**: Можно заморозить поворот по определенным осям
- **Статические методы**: Простое создание billboard-текста

### 5. Интеграция с существующей системой

#### Изменения в `CombatSystem.cs`
- Поддержка новой системы оружия с сохранением обратной совместимости
- Динамическая дальность атаки в зависимости от оружия
- Учет скорости атаки каждого оружия

#### Изменения в `Character.cs`
- Автоматическое добавление `WeaponSystem` каждому персонажу
- Интеграция с существующей системой инвентаря

## Использование

### Создание оружия

```csharp
// Создание оружия ближнего боя
MeleeWeapon knife = MeleeWeapon.CreatePresetWeapon(MeleeWeaponCategory.Knife, ItemRarity.Common);
MeleeWeapon sword = MeleeWeapon.CreatePresetWeapon(MeleeWeaponCategory.Sword, ItemRarity.Epic);

// Создание огнестрельного оружия
RangedWeapon pistol = RangedWeapon.CreatePresetWeapon(RangedWeaponCategory.Pistol, ItemRarity.Common);
RangedWeapon rifle = RangedWeapon.CreatePresetWeapon(RangedWeaponCategory.Rifle, ItemRarity.Rare);
```

### Управление оружием персонажа

```csharp
Character character = GetComponent<Character>();
WeaponSystem weaponSystem = character.GetComponent<WeaponSystem>();

// Добавление оружия
weaponSystem.AddWeapon(newWeapon);

// Ручной выбор оружия
weaponSystem.SetCurrentWeapon(specificWeapon);

// Автоматическая атака (выберет подходящее оружие)
weaponSystem.AttackTarget(enemy);

// Получение информации
string weaponInfo = weaponSystem.GetCurrentWeaponInfo();
bool canAttack = weaponSystem.CanAttackWithCurrentWeapon();
```

### Создание billboard-текста

```csharp
// Простое создание текста урона
GameObject damageText = LookAtCamera.CreateBillboardText(
    "-50",                      // Текст
    targetPosition,             // Позиция
    Color.red,                  // Цвет
    24                          // Размер шрифта
);

// Ручное добавление компонента
LookAtCamera billboard = myGameObject.AddComponent<LookAtCamera>();
billboard.SetAxisConstraints(false, true, false); // Заморозить Y-ось
```

### Тестирование

Добавьте `WeaponSystemTest` на любой GameObject для запуска тестов:

```csharp
// В редакторе: нажмите 'T' для запуска тестов системы оружия
// Нажмите 'Y' для тестирования отображения текста урона
// Или используйте контекстное меню "Show Weapon System Info"
```

## Характеристики оружия по типам

### Ближний бой
| Тип | Урон | Скорость | Точность | Крит. шанс | Особенности |
|-----|------|----------|----------|------------|-------------|
| Нож | 15 | 1.5 | 90% | 15% | Быстрое, точное |
| Меч | 25 | 1.0 | 85% | 10% | Сбалансированное |
| Дубинка | 35 | 0.7 | 80% | 5% | Медленное, мощное |
| Топор | 30 | 0.8 | 75% | 20% | Высокий крит. урон |

### Огнестрельное
| Тип | Урон | Дальность | Магазин | Перезарядка | Особенности |
|-----|------|-----------|---------|-------------|-------------|
| Пистолет | 20 | 8 | 12 | 1.5с | Универсальное |
| Винтовка | 40 | 15 | 8 | 2.5с | Дальнобойное, точное |
| Дробовик | 60 | 5 | 6 | 3.0с | Ближний бой, мощное |
| ПП | 15 | 6 | 25 | 2.0с | Автоматическое |

## Модификаторы редкости

- **Обычное**: базовые характеристики
- **Необычное**: +20% к характеристикам
- **Редкое**: +50% к характеристикам
- **Эпическое**: +100% к характеристикам
- **Легендарное**: +200% к характеристикам

## Особенности системы

### Автоматический выбор оружия
Система автоматически выбирает наиболее подходящее оружие на основе:
- Дистанции до цели
- Наличия патронов (для огнестрельного)
- Состояния оружия (прочность)
- Эффективности урона

### Баллистика (RimWorld-стиль)
- Снаряды физически летят к цели
- Разброс зависит от точности оружия
- Возможность попадания в препятствия
- Реалистичные траектории полета

### Прочность и обслуживание
- Оружие изнашивается при использовании
- Сломанное оружие наносит только 10% урона
- Возможность ремонта оружия

## Конфигурация

Все основные параметры настраиваются в инспекторе Unity:

### WeaponSystem
- `meleePreferenceRange`: дистанция предпочтения ближнего боя (по умолчанию 3)
- `rangedPreferenceRange`: дистанция предпочтения огнестрельного (по умолчанию 8)
- `autoReloadEnabled`: автоматическая перезарядка (по умолчанию true)
- `debugMode`: режим отладки (по умолчанию false)

### Bullet
- `damage`: урон снаряда
- `speed`: скорость полета
- `accuracy`: точность (влияет на разброс)
- `penetrateTargets`: может ли пробивать цели

## Логи и отладка

Система записывает подробные логи в `C:\Users\[Username]\AppData\LocalLow\DefaultCompany\VoidFrontier\`

Для включения отладочного режима установите `debugMode = true` в соответствующих компонентах.

## Требования

- Unity 2022.3.62f1 или выше
- Существующие компоненты: Character, CombatSystem, CharacterMovement
- Система сетки (GridManager) для корректного позиционирования

## Файлы системы

```
Assets/Scripts/
├── Weapon.cs                 # Базовый класс оружия
├── MeleeWeapon.cs           # Оружие ближнего боя
├── RangedWeapon.cs          # Огнестрельное оружие
├── Bullet.cs                # Система снарядов
├── WeaponSystem.cs          # Менеджер оружия персонажа
├── LookAtCamera.cs          # Billboard компонент для текста урона
├── WeaponSystemTest.cs      # Тестовый скрипт
└── Editor/
    └── BuildScript.cs       # Скрипт сборки и тестирования
```

## Совместимость

Система полностью интегрирована с существующим кодом:
- ✅ Сохранена работа старой боевой системы
- ✅ Автоматическое добавление компонентов к персонажам
- ✅ Работа с существующей системой ИИ
- ✅ Интеграция с системой выделения и движения

Персонажи без WeaponSystem будут использовать старую систему боя.